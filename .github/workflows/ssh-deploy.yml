name: Deploy to VPS

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v3
      
      # - name: SSH
      #   uses: webfactory/ssh-agent@v0.7.0
      #   with:
      #     ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # - name: Install Node.js
      #   uses: actions/setup-node@v3
      #   with:
      #     node-version: '16.x'

      # - name: Install npm dependencies
      #   run: npm install

      - name: Write SSH Private Key
        # check this thread to understand why its needed:
        # https://stackoverflow.com/a/70447517
        run: |
          install -m 600 -D /dev/null ~/.ssh/id_rsa
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} > ~/.ssh/known_hosts
      
      - name: Rsync Version & Node Version & NPM Version
        run: |
          rsync --version
          node -v
          npm -v
      
      - name: Private Key
        run: cat ~/.ssh/id_rsa

      # - name: Rsync Deployments
      #   uses: burnett01/rsync-deployments@5.2.1
      #   with:
      #     switches: -avzr --delete
      #     path: dist/
      #     remote_path: ${{ secrets.WORK_DIR }} #/var/www/test.scalatrades.com/html/
      #     remote_host: ${{ secrets.SSH_HOST }}
      #     remote_user: ${{ secrets.SSH_USER }}
      #     remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # - name: SSH Deployments
      #   uses: easingthemes/ssh-deploy@main
      #   env:
      #     SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      #     REMOTE_HOST: ${{ secrets.SSH_HOST }}
      #     REMOTE_USER: ${{ secrets.SSH_USER }}
      #     # ARGS: "-rlgoDzvc -i --delete"
      #     SOURCE: "dist/"
      #     TARGET: ${{ secrets.WORK_DIR }}
      #     # EXCLUDE: "/dist/, /node_modules/"

      - name: Deploy to Staging server
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.SSH_HOST }}
          REMOTE_USER: ${{ secrets.SSH_USER }}
          ARGS: "-rlgoDzvc -i"
          SOURCE: "dist/"          
          TARGET: ${{ secrets.WORK_DIR }}
          # EXCLUDE: "/dist/, /node_modules/"
          SCRIPT_BEFORE: |
            whoami
            ls -al
          SCRIPT_AFTER: |
            whoami
            ls -al
            echo $RSYNC_STDOUT